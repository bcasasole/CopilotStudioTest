<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot Studio Expert</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        header {
            background-color: #0078d4;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }

        main {
            padding: 2rem;
        }

        section {
            margin-bottom: 2rem;
        }

        footer {
            background-color: #0078d4;
            color: #fff;
            text-align: center;
            padding: 1rem;
            position: fixed;
            width: 100%;
            bottom: 0;
        }

        img {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }

        .chat-container {
            height: calc(100% - 50px);
            width: 100%;
            position: fixed;
            top: 50px;
        }

        #webchat {
            height: 100%;
        }

        .login-container {
            z-index: 100;
            position: absolute;
            margin-top: 50px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            background-color: black;
        }

        .login-container label {
            color: white;
        }

        .login-container button {
            background-color: aliceblue;
        }
    </style>
</head>

<body>
    <header>
        <h1>Copilot Studio Expert</h1>
    </header>
    <main>
        <section>
            <h2>Overview</h2>
            <p>Copilot Studio is a powerful platform that allows you to build AI-driven agents easily. It integrates with
                various data sources and provides generative answers to enhance user interactions.</p>
            <img src="https://ih1.redbubble.net/image.5277168262.4061/bg,f8f8f8-flat,750x,075,f-pad,750x1000,f8f8f8.jpg"
                alt="Copilot Studio Overview" width="100" height="133" />
        </section>
        <section>
            <h2>Key Features</h2>
            <ul>
                <li>Generative AI for creating intelligent agents</li>
                <li>Integration with Power Platform and Dynamics 365</li>
                <li>Support for multiple knowledge sources</li>
                <li>Customizable actions and connectors</li>
                <li>Analytics for monitoring and improving agent performance</li>
            </ul>
            <img src="https://blog.topedia.com/wp-content/uploads/2023/11/MicrosoftCopilotStudio_1200x627-1.png"
                alt="Copilot Studio Features" width="266" height="139" />
        </section>
        <div style="display: flex;">
            <div style="flex: 1; padding-right: 30px;">
                <h2>How It Works</h2>
                <p>Copilot Studio uses a combination of predefined topics, generative answers, and custom actions to
                    provide a comprehensive AI solution. This powerful platform allows you to create intelligent agents
                    that can handle a wide range of tasks and interactions. With predefined topics, you can quickly set
                    up common scenarios and workflows, ensuring your agents are ready to assist users right away.</p>
                <p>Generative answers enable your agents to provide dynamic and contextually relevant responses,
                    enhancing the user experience by delivering personalized and accurate information. Custom actions
                    allow you to extend the capabilities of your agents, integrating with various services and APIs to
                    perform specific tasks or retrieve data as needed.</p>
                <p>Copilot Studio makes it easy to configure and deploy agents across multiple channels, including
                    websites, Microsoft Teams, and other communication platforms. This flexibility ensures that your AI
                    solutions can reach users wherever they are, providing consistent and reliable support across
                    different environments.</p>
            </div>
            <div style="display: flex; justify-content: flex-end;">
                <iframe src="https://copilotstudio.microsoft.com/environments/b082486f-6e00-e830-b9cc-ef3eeef15a41/bots/cr1dd_copilotStudioExpert/webchat?__version__=2"
                    frameborder="0" style="width: 330px; height: 550px;"></iframe>
            </div>
        </div>
        <div class="chat-container">
            <div class="login-container">
                <label id="userName">Not logged in.</label>
                <button id="login" onclick="onSignInClick()">Log In</button>
            </div>
            <div id="webchat"></div>
        </div>
    </main>
    <footer>
        <p>&copy; 2025 Copilot Studio Expert</p>
    </footer>

    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script src="https://alcdn.msauth.net/lib/1.2.0/js/msal.js"></script>
    <script src="https://unpkg.com/@azure/storage-blob@10.3.0/browser/azure-storage.blob.min.js"
        integrity="sha384-fsfhtLyVQo3L3Bh73qgQoRR328xEeXnRGdoi53kjo1uectCfAHFfavrBBN2Nkbdf" crossorigin="anonymous">
    </script>
    <script>
        if (typeof Msal === 'undefined') {
            document.write(unescape("%3Cscript src='https://alcdn.msftauth.net/lib/1.2.0/js/msal.js' type='text/javascript'%3E%3C/script%3E"));
        }

        function onSignin(idToken) {
            const user = clientApplication.getAccount();
            document.getElementById("userName").innerHTML = "Currently logged in as " + user.name;
        }

        function onSignInClick() {
            const requestObj = {
                scopes: ["user.read", 'openid', 'profile']
            };

            clientApplication.loginPopup(requestObj).then(onSignin).catch(function (error) {
                console.log(error);
            });
        }

        function getOAuthCardResourceUri(activity) {
            if (activity &&
                activity.attachments &&
                activity.attachments[0] &&
                activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth' &&
                activity.attachments[0].content.tokenExchangeResource) {
                return activity.attachments[0].content.tokenExchangeResource.uri;
            }
        }

        function exchangeTokenAsync(resourceUri) {
            const user = clientApplication.getAccount();
            if (user) {
                const requestObj = {
                    scopes: [resourceUri]
                };
                return clientApplication.acquireTokenSilent(requestObj)
                    .then(function (tokenResponse) {
                        return tokenResponse.accessToken;
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            } else {
                return Promise.resolve(null);
            }
        }

        async function fetchJSON(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    accept: 'application/json'
                }
            });

            if (!res.ok) {
                throw new Error(`Failed to fetch JSON due to ${res.status}`);
            }

            return await res.json();
        }

        let clientApplication;
        (function () {
            const msalConfig = {
                auth: {
                    clientId: '1c77eb0c-cc47-4420-aefe-8e5c2f35f71f',
                    authority: 'https://login.microsoftonline.com/c87f36f7-fc65-453c-9019-0d724f21bc42'
                },
                cache: {
                    cacheLocation: 'localStorage',
                    storeAuthStateInCookie: false
                }
            };
            if (!clientApplication) {
                clientApplication = new Msal.UserAgentApplication(msalConfig);
            }
        }());

        (async function main() {
            const account = clientApplication.getAccount();
            if (!account) {
                const requestObj = {
                    scopes: ["user.read", 'openid', 'profile']
                };
                await clientApplication.loginPopup(requestObj).then(onSignin).catch(function (error) {
                    console.log(error);
                });
            }

            const theURL = "https://b082486f6e00e830b9ccef3eeef15a.41.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr1dd_copilotStudioExpert/directline/token?api-version=2022-03-01-preview";

            const userId = account ? ("CopilotExpertApp" + account.accountIdentifier).substr(0, 64) : (Math.random().toString() + Date.now().toString()).substr(0, 64);

            const { token } = await fetchJSON(theURL);
            const directLine = window.WebChat.createDirectLine({ token });
            const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
                const { type } = action;
                if (type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                    dispatch({
                        type: 'WEB_CHAT/SEND_EVENT',
                        payload: {
                            name: 'startConversation',
                            type: 'event',
                            value: { text: "hello" }
                        }
                    });
                    return next(action);
                }
                if (type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                    const activity = action.payload.activity;
                    let resourceUri;
                    if (activity.from && activity.from.role === 'bot' &&
                        (resourceUri = getOAuthCardResourceUri(activity))) {
                        exchangeTokenAsync(resourceUri).then(function (token) {
                            if (token) {
                                directLine.postActivity({
                                    type: 'invoke',
                                    name: 'signin/tokenExchange',
                                    value: {
                                        id: activity.attachments[0].content.tokenExchangeResource.id,
                                        connectionName: activity.attachments[0].content.connectionName,
                                        token
                                    },
                                    from: {
                                        id: userId,
                                        name: account.name,
                                        role: "user"
                                    }
                                }).subscribe(
                                    id => {
                                        if (id === 'retry') {
                                            return next(action); // bot was not able to handle the invoke, so display the oauthCard
                                        }
                                    },
                                    error => {
                                        return next(action); // an error occurred to display the oauthCard
                                    }
                                );
                            } else {
                                return next(action);
                            }
                        });
                    } else {
                        return next(action);
                    }
                } else {
                    return next(action);
                }
            });

            const styleOptions = {
                hideUploadButton: true
            };

            window.WebChat.renderWebChat(
                {
                    directLine,
                    store,
                    userId,
                    styleOptions
                },
                document.getElementById('webchat')
            );
        })().catch(err => console.error("An error occurred: " + err));
    </script>
</body>

</html>
